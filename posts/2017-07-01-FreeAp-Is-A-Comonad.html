<!DOCTYPE HTML>
<html><head><title>Functorial Blog - FreeAp is a Comonad</title><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto+Slab:300"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto+Mono:300"><link rel="stylesheet" type="text/css" href="../assets/default.css"><meta name="viewport" content="width=device-width, initial-scale=1"><script type="text/javascript" src="../assets/gaq.js"></script></head><body><header><h1>FreeAp is a Comonad</h1><p>by Phil Freeman on 2017/07/01</p><hr></header><main><p>While thinking about <a href="http://blog.functorial.com/posts/2016-08-07-Comonads-As-Spaces.html">comonads as spaces</a> and <a href="http://blog.functorial.com/posts/2016-08-08-Comonad-And-Day-Convolution.html">Day convolution</a>, I realized an interesting thing. The free applicative functor generated by a comonad <code>f</code> is also a comonad.</p>
<p>The free applicative can be defined in a few different ways, but I like to define it like this:</p>
<pre class="purescript"><code>data FreeApplicative f a = Pure a | Free (Day f (FreeApplicative f) a)
</code></pre>
<p>Here, <code>Day</code> is taken from my <code>purescript-day</code> package. I think this presentation makes it easy to understand the free applicative, since it is just a Day convolution of a finite number of copies of <code>f</code>. It also makes it simple to define various operations like <code>hoistFreeAp</code>.</p>
<p>If we refactor this slightly to use a <code>Coproduct</code>, then a <code>Comonad</code> instance can even be derived:</p>
<pre class="purescript"><code>newtype FreeApplicative f a = FreeApplicative (Coproduct Identity (Day f (FreeApplicative f)) a)

derive newtype instance functorFreeApplicative :: Functor f =&gt; Functor (FreeApplicative f)
derive newtype instance extendFreeApplicative :: Extend f =&gt; Extend (FreeApplicative f)
derive newtype instance comonadFreeApplicative :: Comonad f =&gt; Comonad (FreeApplicative f)
</code></pre>
<p>This works since <code>Identity</code> is a comonad, and <code>Coproduct</code> and <code>Day</code> both preserve comonads.</p>
<p>In the comonads as spaces approach to user interfaces, the free applicative gives a way to build a UI for a finite list of subcomponents, just like <code>Day</code> gives us a way to compose two subcomponents.</p>
<p>Unfortunately, <code>FreeAp</code> isn&#39;t a <code>Comonad</code> transformer. The problem is that we would not be able to handle the <code>Pure</code> case if we tried to <code>lower</code> a <code>FreeAp w</code> to a <code>w</code>.</p>
<p>However, we can construct a <code>ComonadTrans</code> instance if we restrict ourselves to a Day convolution of a non-zero number of copies of <code>f</code>. Instead of the free <code>Applicative</code>, this gives us the free <code>Apply</code>:</p>
<pre class="purescript"><code>newtype FreeApplicative f a = FreeApplicative (Coproduct Identity (FreeApply f) a)

derive newtype instance functorFreeApplicative :: Functor f =&gt; Functor (FreeApplicative f)
derive newtype instance extendFreeApplicative :: Extend f =&gt; Extend (FreeApplicative f)
derive newtype instance comonadFreeApplicative :: Comonad f =&gt; Comonad (FreeApplicative f)

newtype FreeApply f a = FreeApply (Day f (FreeApplicative f) a)

derive newtype instance functorFreeApply :: Functor f =&gt; Functor (FreeApply f)
derive newtype instance extendFreeApply :: Extend f =&gt; Extend (FreeApply f)
derive newtype instance comonadFreeApply :: Comonad f =&gt; Comonad (FreeApply f)
</code></pre>
<p>Now, we can write a <code>ComonadTrans</code> instance for <code>FreeApply</code> which keeps the first <code>w</code> in a non-empty collection of <code>w</code>s, and <code>extract</code>s the focus from the rest.</p>
<pre class="purescript"><code>instance comonadTransFreeApply :: ComonadTrans FreeApply where
  lower (FreeApply d) = runDay (\f w fa -&gt; map (\x -&gt; f x (extract fa)) w) d
</code></pre>
</main><footer><hr><p class="text-muted"><small>Â© Phil Freeman 2010-2021</small></p></footer></body></html>